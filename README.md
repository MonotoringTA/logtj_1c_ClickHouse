# RDV-LogT: анализ длительных операций по технологическому журналу 1С (загрузка в ClickHouse)

> Потоковое чтение полного технологического журнала 1С (ТЖ), фильтрация, разбиение на отдельные операции и загрузка результатов в **ClickHouse**.

[![Python](https://img.shields.io/badge/Python-3.13%2B-blue.svg)]()
[![ClickHouse](https://img.shields.io/badge/ClickHouse-supported-brightgreen.svg)]()
[![Status](https://img.shields.io/badge/status-active-success.svg)]()

Версия движка: **1.0.0** (см. `main.py`)

---

## Содержание
- [Кратко](#кратко)
- [Архитектура](#архитектура)
- [Установка](#установка)
- [Конфигурация технологического журнала](#конфигурация-технологического-журнала)
- [Быстрый старт](#быстрый-старт)
- [Конфигурация `config.json`](#конфигурация-configjson)
- [Схема таблиц ClickHouse](#схема-таблиц-clickhouse)
- [Минимальные системные требования для сервера ClickHouse](#минимальные-системные-требования-для-сервера-clickhouse)
- [Логирование](#логирование)
- [Ограничения](#ограничения)
- [Лицензия](#лицензия)

---

## Кратко

Скрипт выполняет:
- Построчное **чтение полного технологического журнала 1С (rphost)**.
- Автоматическое выделение всех событий одной операции: `VRSREQUEST → … → VRSRESPONSE`.
- Фильтрацию операций по длительности и количеству событий.
- Загрузку:
  - операций (`operations`),
  - событий (`events`),
  - статистики событий (`event_stats`)  
  в ClickHouse.

---

## Архитектура

```
├── main.py                  # Точка входа: загрузка конфигурации, парсинг, вставка в ClickHouse
├── config.json              # Конфигурация подключения и параметров обработки
├── create_table_clickhouse.txt # SQL-схемы для ClickHouse
├── requirements.txt         # Зависимости Python
```

Ключевые моменты:
- Построчное чтение файлов `.log` из каталогов рабочих процессов `rphost_*` (`utf-8`, `utf-8-sig`).
- События собираются в одну операцию по `clientID`. Начало операции определяется событием `VRSREQUEST`, конец — событием `VRSRESPONSE`. 
- Выполняется подсчёт статистики событий операции (сумма длительности, количество, % от общей длительности операции).
- Все операции и события загружаются (`JSONEachRow`) в ClickHouse.
- Анализ операций и событий внутри них выполняется обработкой **«Трассировка длительных операций»** на базе 1С.

---

## Установка

Для работы инструмента необходимо обеспечить наличие следующего ПО:

- **Python 3.13+**
- **ОС**: Windows / Linux
- **ClickHouse 25.6+**

Установка зависимостей:
```bash
pip install -r requirements.txt
```

`requirements.txt`:
```txt
requests
tqdm
```

---

## Конфигурация технологического журнала

Перед трассировкой длительных операций необходимо включить полный или ограниченный технологический журнал. Но обязательно требуется собирать события `VRSREQUEST` и `VRSRESPONSE`.
Примеры конфигураций технологического журнала [logcfg-full.xml](docs/example/logcfg-full.xml) или [logcfg-filter.xml](docs/example/logcfg-filter.xml)

---

## Быстрый старт

1. Загрузите файл [create_table_clickhouse.txt](create_table_clickhouse.txt) на сервер ClickHouse.

   Подготовьте таблицы в ClickHouse:
   ```bash
   clickhouse-client --multiquery < create_table_clickhouse.txt
   ```
   С указанием пароля default пользователя:
   ```bash
   clickhouse-client --password --multiquery < create_table_clickhouse.txt
   ```
   
   Будет создана база данных **tracelog** с необходимыми таблицами.

2. Скачайте расширение из [каталога releases_1c](releases_1c). Оно содержит все необходимые объекты конфигурации для анализа результатов обработки полного технологического журнала. 

3. Подключите расширение в любую базу 1С. Версия платформы 1С:Предприятие от 8.3.21.

4. Настройте подключение к базе данных ClickHouse в расширении.

5. Откройте обработку **«Трассировка длительных операций»**. 

6. Укажите базу данных и набор данных. Перейдите на страницу **Операции**. Запустите обработку файлов технологического журнала и загрузку в ClickHouse командой **Обработать данные ТЖ**. Укажите пути к файлам технологического журнала и каталогу хранения логов обработки. Конфигурационный файл `config.json` будет создан автоматически и запущен скрипт Python.

6. После загрузки в ClickHouse вернитесь в обработку **«Трассировка длительных операций»** на страницу **Операции** и нажмите «Загрузить».

Подробное руководство: [Анализ технологического журнала через обработку «Трассировка длительных операций»](docs/user_guide.md)

---

## Конфигурация `config.json`

| Блок          | Ключ                         | Назначение |
|---------------|------------------------------|------------|
| `clickhouse`  | `url`, `user`, `password`, `database` | Подключение к ClickHouse |
| `processing`  | `batch_size` | Размер батча при вставке. По умолчанию - 100 событий |
|               | `timeout`   | Таймаут запроса к ClickHouse. По умолчанию - 30 секунд |
|               | `dataset_name` | Метка набора данных |
| `filtering`   | `min_operation_duration_ms` | Минимальная длительность операции. По умолчанию - 1 секунда |
|               | `min_operation_events` | Минимум событий в операции. По умолчанию - 3 события |
| `paths`       | `input_dir` | Каталог технологического журнала 1С |
|               | `log_dir`   | Каталог логов скрипта |

---

## Схема таблиц ClickHouse

См. файл [`create_table_clickhouse.txt`](create_table_clickhouse.txt).  
Три таблицы:
- **operations** — список операций (`session_id`, `client_id`, `vrs_session`, время, длительность, context).
- **events** — все события в операции.
- **event_stats** — статистика по событиям (сумма длительностей, количество, %).

---

## Минимальные системные требования для сервера ClickHouse

- **CPU**: Intel Core i5 или AMD Ryzen 5 и последующие модели
- **RAM**: 8 ГБ и выше
- **Диск**: SSD от 20 ГБ
- **ОС**: Linux x86_64

---

## Логирование

- Все логи пишутся в каталог `log_dir` из `config.json`.
- Формат: `trace-vrs-YYYYMMDD_HHMMSS.log`.
- Также выводятся в консоль.

---

## Ограничения

- Перед каждой загрузкой выбранный набор данных (`dataset`) очищается автоматически.
- Файлы логов должны соответствовать структуре ТЖ 1С (`rphost_*/*.log`).
- Работает только с кодировками `utf-8` и `utf-8-sig`.
- Фильтрация операций выполняется по длительности и количеству событий (см. параметры в `config.json`).

---

## Лицензия

Проект распространяется под лицензией **BSD 3-Clause**.  
Подробности см. в файле [LICENSE](LICENSE).

---
